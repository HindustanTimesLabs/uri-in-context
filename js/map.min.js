function type(a){return a.attacks=+a.attacks,a.civilian=+a.civilian,a.militant=+a.militant,a.secforce=+a.secforce,a.total=+a.total,a}function legend(a){$(".legend").empty(),$(".legend").append('<div class="row swatch-container"></div><div class="row label-container"></div>'),buckets.forEach(function(a,b){$(".swatch-container").append('<div class="col-md-2 col-sm-2 col-xs-2 swatch bucket-'+(b+1)+'"></div>'),$(".label-container").append('<div class="col-md-2 col-sm-2 col-xs-2 legend-label">'+a+"</div>")})}function colors(a,b){for(var c=b[b.length-1],d=0;d<b.length;d++){var e=b[d],f=b[d+1];a.forEach(function(a,b){"Pakistan Occupied Kashmir"!=a.district&&(a.attacks!=c?a.attacks>=e&&a.attacks<f&&$("path.subunit.district-"+a.censuscode).attr("bucket",d+1):$("path.subunit.district-"+a.censuscode).attr("bucket",5))})}$(".subunit").each(function(){var a=$(this).attr("bucket");$(this).addClass("bucket-"+a)})}function tip(a){a.forEach(function(a){$(".district-"+a.censuscode).mousemove(function(b){var c=$(this).css("fill");$(".subunit").removeClass("highlight");var d=$(".tip").height(),e=$(".tip").width(),f=+$(".tip").css("padding-left").split("p")[0];e+=2*f;var h=(+$(".tip").css("padding-top").split("p")[0],$(window).width()),i=$(window).height()+$(window).scrollTop(),j=b.pageX-e/2,k=j+e;j=j<5?5:k>h-5?h-5-e:b.pageX-e/2;var l=b.pageY+30,m=l+d+20;l=m>i-100?b.pageY-25-d:b.pageY-25-d,$(".tip").empty(),$(".tip").append('<div class="title">'+a.district+"</div>"),"Pakistan Occupied Kashmir"!=a.district&&($(".tip").append('<div class="tip-item total"><div class="key">Total attacks</div><div class="value"><div class="swatch" style="background:'+c+'"></div>'+a.attacks+"</div></div>"),$(".tip").append('<div class="tip-item subtitle total"><div class="key">Total fatalities</div><div class="value">'+a.total+"</div></div>"),$(".tip").append('<div class="tip-item"><div class="key">Militants</div><div class="value">'+a.militant+"</div></div>"),$(".tip").append('<div class="tip-item"><div class="key">Indian security forces</div><div class="value">'+a.secforce+"</div></div>"),$(".tip").append('<div class="tip-item"><div class="key">Civilians</div><div class="value">'+a.civilian+"</div></div>")),$(".tip").css({left:j,top:l}),$(".tip").show()}),$(".district-"+a.censuscode).mouseout(function(){$(".tip").hide()})})}function mapScale(a){return"sm"==a?y=2500:y=6500,y}function mapCenter(a){return"sm"==a?y=32:y=34.85,y}function mapRotate(a){return"sm"==a?y=-85.5:y=-77.55,y}d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})},d3.selection.prototype.moveToBack=function(){return this.each(function(){var a=this.parentNode.firstChild;a&&this.parentNode.insertBefore(this,a)})};var buckets=[0,1,5,10,25,56];$(document).ready(function(){var a=$(".map-wrapper").width(),b=$("#map").height(),d=d3.geoAlbers().center([0,mapCenter(breakpoint)]).rotate([mapRotate(breakpoint),0]).parallels([50,60]).scale(mapScale(breakpoint)),e=d3.geoPath().projection(d).pointRadius(2),f=d3.select("#map").append("svg").attr("width",a).attr("height",b),g=f.append("g");$("body").append('<div class="tip"></div>'),$(".tip").hide(),d3.json("data/jk_districts.json",function(a,b){if(a)throw a;g.selectAll(".subunit").data(topojson.feature(b,b.objects.jk_districts_2011).features).enter().append("path").attr("class",function(a){return"subunit district-"+a.properties.censuscode}).attr("d",e).on("mouseover",function(a){d3.select(this).moveToFront(),d3.selectAll(".place").moveToFront(),d3.selectAll(".place-label").moveToFront(),$(".highlight").removeClass("highlight")}).on("mouseout",function(a){d3.select(this).moveToBack()}),d3.csv("data/districts.csv",type,function(a,b){function d(a){tip(c),legend(a),colors(a,buckets)}var c=b;d(b)}),g.append("path").datum(topojson.mesh(b,b.objects.jk_districts_2011,function(a,b){return a===b})).attr("d",e).attr("class","subunit-boundary"),g.append("path").datum(topojson.feature(b,b.objects.places)).attr("d",e).attr("class","place"),g.selectAll(".place-label").data(topojson.feature(b,b.objects.places).features).enter().append("text").attr("class","place-label").attr("transform",function(a){return"translate("+d(a.geometry.coordinates)+")"}).attr("dy",".35em").text(function(a){return a.properties.name}),g.selectAll(".place-label").attr("x",function(a){return a.geometry.coordinates[0]>-1?6:-6}).style("text-anchor",function(a){return a.geometry.coordinates[0]>-1?"start":"end"})})});
